<!DOCTYPE html>
<html lang="en">
<!-- Cabecera-->

<!-- -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document</title>
    <!--Dependencias extras-->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <link href="src/style.css" rel="stylesheet">
    <!--Cronometro-->
    <script type="text/javascript" src="src/TimeCircles/TimeCircles.js"></script>
    <link href="src/TimeCircles/TimeCircles.css" rel="stylesheet">
    <!--MQTT-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"
        type="text/javascript"></script>
</head>

<body>
    <div id="cronometro" data-timer="0"></div>
    <button id="boton_start">Start</button>
    <button id="boton_pause">Pause</button>
    <ol reversed id="mqtt_list">Lista MQTT</ol>
</body>

<script>
    /*CRONOMETRO*/
    console.log("inicio cronometro")
    $("#cronometro").TimeCircles({ start: false,count_past_zero: true});
    $("#boton_pause").click(() => {
        console.log("click stop")
        pausar()
    }
    );
    $("#boton_start").click(() => {
        console.log("click iniciar")
        iniciar()
    }
    );
    //Pausa el cronometro
    function pausar() {
        $("#cronometro").TimeCircles().stop();
    }
    //Reanuda el cronometro
    function iniciar() {
        $("#cronometro").TimeCircles().start();
    }

    /*MQTT*/
    //datos de conexion a broker
    host = 'mqttws.safeko.cl';	// hostname or IP address
    port = 443;
    topic = 'smartu/cronometro';		// topic to subscribe to
    useTLS = true;
    username = "loraserver";
    password = "SwarmTechnologies192";
    cleansession = true;
    var client;
    var reconnectTimeout = 2000;

    $(document).ready(function () {
        MQTTconnect();
        //añadir inicio cronometro
    });
    //funcion de conexion
    function MQTTconnect() {
        if (typeof path == "undefined") {
            path = '/smartu';
        }
        client = new Paho.Client(
            host,
            port,
            path,
            "crono" + parseInt(Math.random() * 100, 10)
        );
        var options = {
            timeout: 3,
            useSSL: useTLS,
            cleanSession: cleansession,
            onSuccess: onConnect,
            onFailure: function (message) {
                console.log("Conexion fallida: " + message.errorMessage + "Reintentando");
                setTimeout(MQTTconnect, reconnectTimeout);
            }
        };

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        if (username != null) {
            options.userName = username;
            options.password = password;
        }
        console.log("Host=" + host + ", port=" + port + ", path=" + path + " TLS = " + useTLS + " username=" + username + " password=" + password);
        client.connect(options);
    }
    //Cuando se conecta exitosamente
    function onConnect() {
        console.log('Conectado a ' + host + ':' + port + path);
        // Connection succeeded; subscribe to our topic
        client.subscribe(topic, { qos: 0 });
        console.log(topic);
    }
    //Cuando se pierde la conexion
    function onConnectionLost(response) {
        setTimeout(MQTTconnect, reconnectTimeout);
        console.log("Conexion perdida: " + responseObject.errorMessage + ". Reconectando");

    };
    //Cuando llega un mensaje
    function onMessageArrived(message) {
        var topic = message.destinationName;
        var payload = message.payloadString;
        console.log("Mensaje Recibido***")
        console.log("Topic: "+topic)
        console.log("Mensaje:  "+payload)
        $('#mqtt_list').prepend('<li>' + topic + ' = ' + payload +"Tiempo = "+$("#cronometro").TimeCircles().getTime()+ '</li>');
    };

</script>
<!-- Basado en ejemplo original https://github.com/swarmtechnologies/light-bulb-->
<!-- MQTT script basado en https://jpmens.net/2014/07/03/the-mosquitto-mqtt-broker-gets-websockets-support/
pero con cambio de CDN -->
<!-- Plugin Timecircles utilizado para cronometro http://git.wimbarelds.nl/TimeCircles/index.html -->
<!-- El resto escrito con ♥ por SWARM TECHNOLOGIES SPA-->

</html>